name: "Manual - Test Features (Windows + podman+ WSL 24.04)"
on:
  push:
    branches:
      - "new-action-script-windows-podman-wsl"  
  workflow_dispatch:
    inputs:
      features:
        description: "List of features to execute tests against"
        required: true
        default: "go dotnet"
      baseImage:
        description: "Base image used for devcontainer feature test"
        required: true
        default: "ubuntu:noble"
      logLevel:
        description: "Log Level (info/debug/trace)"
        required: true
        default: "info"
jobs:
  test-windows-wsl:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup WSL (Ubuntu 24.04)
        uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-24.04
          additional-packages: >
            ca-certificates
            curl
            git
            build-essential
            python3
            python3-pip

      - name: Install Node.js 20.x inside WSL
        shell: bash
        run: |
          wsl bash -lc "set -e
            sudo apt-get update
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
            node -v
            npm -v
          "

      - name: Install Dev Containers CLI inside WSL
        shell: bash
        run: |
          wsl bash -lc "npm install -g @devcontainers/cli && devcontainer --version"

      # If you require Docker-in-WSL (for building images) uncomment and adapt:
      #- name: Install Docker Engine inside WSL
       # shell: bash
       # run: |
       #   sudo usermod -aG docker ubuntu
        #   sudo systemctl enable docker || true
#            sudo systemctl start docker || true
#
 #           # Install Docker Buildx system-wide
  #          echo "Installing Docker Buildx system-wide..."
   #         curl -s https://api.github.com/repos/docker/buildx/releases/latest | jq -r ".tag_name"
    #        BUILDX_VERSION="$(curl -s https://api.github.com/repos/docker/buildx/releases/latest | jq -r ".tag_name")"
     #       echo "Installing Buildx version: $BUILDX_VERSION"
            
            # Download and install buildx system-wide
      #      curl -LO https://github.com/docker/buildx/releases/download/v0.29.0/buildx-v0.29.0.linux-amd64
       #     sudo mkdir -p /usr/local/lib/docker/cli-plugins
        #    sudo mv buildx-v0.29.0.linux-amd64 /usr/local/lib/docker/cli-plugins/docker-buildx
         #   sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-buildx

           # # Verify installations
            #docker buildx version || true
      - name: Install Podman Engine inside WSL
        shell: bash
        run: |
          wsl bash -lc '
            echo "=== Starting Podman installation ==="

            # Temporarily disable strict error checking for package installation
            set +e
            sudo apt-get update
            sudo apt-get install -y podman buildah python3-pip jq
            install_exit_code=$?
            set -e
      
            # Check if the installation actually succeeded despite sysctl warnings
            if ! command -v podman >/dev/null 2>&1; then
            echo "ERROR: Podman installation failed"
            exit 1
            fi
      
            if [ $install_exit_code -ne 0 ]; then
              echo "WARNING: Package installation had warnings (likely harmless sysctl error)"
              echo "But Podman is installed and functional - continuing..."
            fi
      
            echo "Packages installed successfully"

            # Configure rootless containers
            echo "Configuring rootless containers..."
            sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 ubuntu
      
            # Install Podman Compose
            echo "Installing Podman Compose..."
            pip3 install --user podman-compose

            # Skip systemctl user services in WSL (they often dont work properly)
            echo "Skipping systemctl user services (WSL compatibility)"

            # Verify installation
            echo "=== Verifying installation ==="
            podman --version
            buildah --version
            ~/.local/bin/podman-compose --version || echo "Podman-compose installed in user directory"
      
            # Test basic Podman functionality
            echo "Testing basic Podman functionality..."
            podman info >/dev/null 2>&1 || echo "Podman info check completed"
      
            echo "=== Podman installation complete ==="
          '
      # Run feature tests.
      - name: Test features inside WSL
        shell: bash
        env:
          FEATURES: ${{ github.event.inputs.features }}
          BASE_IMAGE: ${{ github.event.inputs.baseImage }}
          LOG_LEVEL: ${{ github.event.inputs.logLevel }}
        run: |
          WIN_PWD="$(pwd)"
          WSL_PWD="$(wsl wslpath "$WIN_PWD")"
          echo "Windows path: $WIN_PWD"
          echo "WSL path: $WSL_PWD"
          wsl bash -lc "
            set -e
            echo 'Changing to WSL workspace directory'
            cd '$WSL_PWD'
            
            # Fix common WSL issues
            echo 'Fixing file permissions and line endings...'
            find . -name '*.sh' -exec chmod +x {} \; 2>/dev/null || true
            find . -name '*.sh' -exec dos2unix {} \; 2>/dev/null || true
            
            # Debug information
            echo 'Current directory:' && pwd
            echo 'Feature structure:' && ls -la src/common-utils/ || echo 'common-utils not found'
            echo 'Fixing CRLF line endings...'
            find src/ -name '*.sh' -exec sed -i 's/\r$//' {} \;
            find test/ -name '*.sh' -exec sed -i 's/\r$//' {} \;
            file src/common-utils/install.sh
            # Run the test
            echo 'Testing common-utils against base image...'
            devcontainer features test \
                --features \"common-utils\" \
                --base-image \"mcr.microsoft.com/devcontainers/base:dev-debian-12\" \
                --log-level \"trace\" \
                '\$WSL_PWD'
          "

      # Uncomment if devcontainer test produces logs/reports you want to retain
      # - name: Upload test logs
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: feature-test-logs
      #     path: path/to/logs